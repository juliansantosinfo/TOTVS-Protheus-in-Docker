FROM redhat/ubi8:8.5-236

LABEL release="12.1.2410"
LABEL build="24.3.1.1"
LABEL dbapi="24.1.1.0"
LABEL description="TOTVS Aplication Server Protheus" 
LABEL maintainer="Julian de Almeida Santos <julian.santos.info@gmail.com>"

ENV APPSERVER_MODE=application
ENV APPSERVER_RPO_CUSTOM="/totvs/protheus/apo/custom.rpo"
ENV APPSERVER_DBACCESS_DATABASE=MSSQL
ENV APPSERVER_DBACCESS_SERVER=totvs_dbaccess
ENV APPSERVER_DBACCESS_PORT=7890
ENV APPSERVER_DBACCESS_ALIAS=protheus
ENV APPSERVER_CONSOLEFILE="/totvs/protheus/bin/appserver/appserver.log"
ENV APPSERVER_MULTIPROTOCOLPORTSECURE=0
ENV APPSERVER_MULTIPROTOCOLPORT=1
ENV APPSERVER_LICENSE_SERVER=totvs_licenseserver
ENV APPSERVER_LICENSE_PORT=5555
ENV APPSERVER_PORT=1234
ENV APPSERVER_WEB_PORT=12345
ENV APPSERVER_REST_PORT=8080
ENV APPSERVER_ENVIRONMENT_LOCALFILES=SQLITE
ENV APPSERVER_SQLITE_SERVER=totvs_appsqlite
ENV APPSERVER_SQLITE_PORT=12346
ENV APPSERVER_SQLITE_INSTANCES="1,10,1,1"
ENV LICENSE_WAIT_RETRIES=30
ENV LICENSE_WAIT_INTERVAL=2
ENV DBACCESS_WAIT_RETRIES=30
ENV DBACCESS_WAIT_INTERVAL=2
ENV EXTRACT_RESOURCES=true
ENV DEBUG_SCRIPT=false
ENV TZ=America/Sao_Paulo

COPY ./totvs /totvs
COPY ./entrypoint.sh /entrypoint.sh
COPY ./healthcheck.sh /healthcheck.sh
COPY ./service.sh /service.sh

WORKDIR /

RUN PKG_MGR=$(command -v dnf || command -v microdnf) && \
    $PKG_MGR update -y && \
    $PKG_MGR install -y gzip iputils nano procps-ng dmidecode tar && \
    $PKG_MGR clean all && \
    rm -rf /var/cache/dnf

RUN chmod +x /entrypoint.sh /healthcheck.sh /service.sh

ENTRYPOINT [ "/entrypoint.sh" ]

EXPOSE 1234 12345 8080